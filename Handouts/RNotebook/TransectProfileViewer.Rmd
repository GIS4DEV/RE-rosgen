---
title: "ProfileViewing"
output: html_notebook
---

This RStudio notebook accompanies the Transects and Profiles handout and the Classification handout. In this notebook, you will import the data you generated using the "v.out.ascii" tool in GRASS to visualize and analyze it here. Some packages, like the "readxl" package, are not necessary and can be commented out if you do not need to import a .xlsx file. Then you will calculate average slope for each of your digitized and extracted centerlines. Finally, you will calculate and measure the width of the flood-prone area to use in the entrenchment ratio calculation.

Feel free to email with any questions!
Zach Hilgendorf
zhilgen1@asu.edu
PhD Student, Geography
School of Geographical Sciences and Urban Planning
Arizona State University


```{r}
# The purpose of this chunk is to set the working directory to your preferred location and load the necessary packages.
setwd("E:/ZHilgendorf/GPH692-Kedron/Handouts/Finished") #Set your working directory to your desired folder. Make sure you used forward slashes and the location is quoted.
require(ggplot2) #This package is for data visualization.
library(readxl) #This package allows users to directly import Microsoft Excel .xlsx files (among others)
require(dplyr) #This package allows users to run sequential commands to manipulate and process your data.
```

```{r}
# The purpose of this chunk is to load the necessary data. I had brought my data into Microsoft Excel, so my format differs slightly, but you can import data as a text file or CSV if you prefer, using the "read.csv" or "read.delim" functions.

# I would suggest that you create a single file or sheet for each. Within those, you will need three columns: Distance, Elevation, Attempt. Distance refers to distance along the transect (in meters). Elevation refers to the elevation above mean sea level (in meters). Attempt should be a single number (1, 2, or 3) in reference to which centerline is represented. This will allow you to run things much more simply, with fewer variables to consider.

LongProf <- read_xlsx("Profiles.xlsx", sheet="LongProf")
ValleyProf <- read_xlsx("Profiles.xlsx", sheet="ValleyProf")
```

```{r}
# The purpose of this chunk is to visualize our datasets using the ggplot2 package.This chunk is set up so that your variables do not need to be specified and the chunk can just be run.

ggplot(LongProf) + # This sets the variable (data frame) we will be plotting.
       aes(x = Distance, y = Elevation, color = Attempt) + # This provides the axes designations and how to color the data.
       geom_line() + # This tells ggplot2 to make a line graph. geom_line could be changed to geom_point without issue.
       labs(x = "Distance along the transect (m)", y = "Elevation (masl)", title = "Longitudinal Profile of Extracted Reach") # This sets the axes labels and title of the plot.

ggplot(ValleyProf) +
       aes(x = Distance, y = Elevation, color = Elevation) +
       geom_line() +
       scale_color_gradient(low = "green", high = "brown") + # This establishes a color gradient between green and brown to color the data.
       labs(x = "Distance along the transect (m)", y = "Elevation (masl)", title = "Cross-Sectional Profile of Valley Near CHaMP Point")
```

```{r}
# The purpose of this chunk is to compute the slope of the longitudinal profile (between points) and the average slope of the line. We will use the "dplyr" package for part of this.

LongProf <- LongProf %>% # The "%>%" is called "piping" and it essentially allows us to take the output of a function and sequentially feed it to the next argument. This is very useful for subsetting and tacking on new columns with output data!
  group_by(Attempt) %>% # Here we are subsetting the data based on the attempt number (1-3). 
  mutate(Slope = (abs(((Elevation - lag(Elevation))/(Distance - lag(Distance))*100)))) # Create a column for slope (Change in Vertical Position/Change in Horizontal Position) with absolute values that is relative to the Attempt
         
ggplot(LongProf) +
       aes(x = Distance, y = Slope, color = Slope) +
       geom_line() +
       scale_color_gradient(low = "gray", high = "red") +
       labs(x = "Distance along the transect (m)", y = "Slope (%)", title = "Slope of the Longitudinal Profile of the Extracted Reach")

ggplot(LongProf) +
       aes(x = Distance, y = Elevation, color = Slope) +
       geom_line(size = 2) + # The "size" argument allows us to increase or decrease our point size.
       scale_color_gradient(low = "gray", high = "red") +
       theme_light() +
       labs(x = "Distance along the transect (m)", y = "Elevation (masl)", title = "Longitudinal Profile of Extracted Reach")
```

```{r}
#The purpose of this chunk is to process our data for entry into the Rosgen Stream Classification scheme. This chunk can be run now, or it can be run during the Classification handout. The chunk reports the mean slope (by attempt) and gives you the necessary tools to determine the flood-prone area of the stream to calculate the entrenchment ratio.
LongProf %>%
  group_by(Attempt) %>% 
  summarize(Slope = mean(Slope, na.rm = TRUE)) #This calculates the mean slope, based on the Attempt.

# Now we want to figure out the width of the flood-prone area.

ValleyProf[which.min(ValleyProf$Elevation),] # This finds the minimum elevation, which should correspond to the lowest elevation in the stream channel, and reports the entire row. That part is essential! Double check the reported value with one of the plots you have made before to verify.
StreamElev <- min(ValleyProf$Elevation) # This stores the minimum elevation that you found in the previous step.
MaxBFx2 <- 2 * (INSERT YOUR MAX BANKFULL DEPTH IN PLACE OF THIS TEXT) # Insert the maximum bankfull depth from the shapefile table and your point here to get twice the maximum bankfull depth.
MaxBFx2Elev <- StreamElev + MaxBFx2 # This adds the elevation of the bottom of the stream to twice the bankfull depth, allowing you to get the elevation (above mean sea level) of that variable.

ggplot(ValleyProf) +
       aes(x = Distance, y = Elevation, color = Elevation) +
       geom_line() +
       geom_hline(yintercept = MaxBFx2Elev) + # This adds a horizontal line at a prescribed location. In this case, we are drawing a line at twice the maximum bankfull depth.
       scale_color_gradient(low = "green", high = "brown") +
       labs(x = "Distance along the transect (m)", y = "Elevation (masl)", title = "Cross-Sectional Profile of Valley Near CHaMP Point")

ggplot(ValleyProf) +
       aes(x = Distance, y = Elevation, color = Elevation) +
       geom_point() + # Point chosen here to allow easier determining of the width (points are horizontally spaced by 1 meter)
       geom_hline(yintercept = MaxBFx2Elev) +
       xlim(200,280) + # Sets the x-axis limits. Adjust this value as you zoom in to the correct area.
       ylim(1102,1105) + # Sets the y-axis limits. Adjust this value as you zoom in to the correct area.
       scale_color_gradient(low = "green", high = "brown") +
       labs(x = "Distance along the transect (m)", y = "Elevation (masl)", title = "Determining the Flood-Prone Width")

#Use the last plot, points, and horizontal line to get an approximate distance of the flood-prone area. Keep for your notes and to include in your classification and report.
```

